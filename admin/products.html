<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Products Management - Bastiseva Admin</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
<div class="header">
    <h1>ðŸŽ¯ Bastiseva Admin - Products</h1>
    <button class="logout-btn" onclick="logout()">Logout</button>
</div>

<div class="nav">
    <a href="dashboard.html">Dashboard</a>
    <a href="shops.html">Shops</a>
    <a href="products.html" class="active">Products</a>
    <a href="orders.html">Orders</a>
    <a href="users.html">Users</a>
</div>

<div class="container" id="mainContent" style="display:none;">
    <div class="page-header">
        <h2>Product Management</h2>
        <button class="btn-primary" onclick="openModal()">+ Add New Product</button>
    </div>

    <div class="section">
        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="Search products...">
            <select id="shopFilter">
                <option value="">All Shops</option>
            </select>
            <select id="statusFilter">
                <option value="">All Status</option>
                <option value="true">Available</option>
                <option value="false">Unavailable</option>
            </select>
        </div>

        <div class="table-container" id="productsTableContainer">
            <div class="loading">Loading products...</div>
        </div>
    </div>
</div>

<div id="loadingScreen" class="loading" style="text-align:center; padding: 50px;">Loading Products...</div>

<!-- Add/Edit Product Modal -->
<div id="productModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Add New Product</h3>
            <button class="close-btn" onclick="closeModal()">&times;</button>
        </div>

        <form id="productForm">
            <input type="hidden" id="productId">
            <div class="form-group">
                <label>Product Name *</label>
                <input type="text" id="productName" required placeholder="e.g., Apple (Kashmiri)">
            </div>

            <div class="form-group">
                <label>Shop *</label>
                <select id="productShop" required>
                    <option value="">Select Shop</option>
                </select>
            </div>

            <div class="form-group">
                <label>Category</label>
                <input type="text" id="productCategory" placeholder="(Auto-filled from shop)" readonly>
            </div>

            <div class="form-group">
                <label>Description</label>
                <textarea id="productDescription" placeholder="Product description..."></textarea>
            </div>

            <div class="form-group">
                <label>Base Price (â‚¹) *</label>
                <input type="number" id="productPrice" required placeholder="120">
            </div>

            <div class="form-group">
                <label>Unit *</label>
                <select id="productUnit" required>
                    <option value="">Select Unit</option>
                    <option value="kg">Kilogram (kg)</option>
                    <option value="gm">Gram (gm)</option>
                    <option value="piece">Piece</option>
                    <option value="dozen">Dozen</option>
                    <option value="plate">Plate</option>
                    <option value="liter">Liter (L)</option>
                    <option value="ml">Milliliter (ml)</option>
                    <option value="strip">Strip</option>
                    <option value="box">Box</option>
                </select>
            </div>

            <div class="form-group">
                <label>Image URL (Optional)</label>
                <input type="url" id="productImageUrl" placeholder="https://example.com/image.jpg">
            </div>

            <div class="form-group">
                <label>Status</label>
                <select id="productStatus">
                    <option value="true">Available</option>
                    <option value="false">Unavailable</option>
                </select>
            </div>

            <div class="form-actions">
                <button type="button" class="btn-cancel" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn-primary" id="btnSave">Save Product</button>
            </div>
        </form>
    </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<script src="../js/common.js"></script>
<script>
    const db = firebase.firestore();
    let allShops = [];
    let allProducts = [];

    const modal = document.getElementById('productModal');
    const productForm = document.getElementById('productForm');
    const modalTitle = document.getElementById('modalTitle');

    function openModal(product = null) {
        productForm.reset();
        document.getElementById('productId').value = '';

        if (product) {
            modalTitle.textContent = 'Edit Product';
            document.getElementById('productId').value = product.id;
            document.getElementById('productName').value = product.name;
            document.getElementById('productShop').value = product.shopId;
            document.getElementById('productCategory').value = product.category;
            document.getElementById('productDescription').value = product.description;
            document.getElementById('productPrice').value = product.price;
            document.getElementById('productUnit').value = product.unit;
            document.getElementById('productImageUrl').value = product.imageUrl;
            document.getElementById('productStatus').value = product.isAvailable.toString();
        } else {
            modalTitle.textContent = 'Add New Product';
        }

        modal.style.display = 'flex';
    }

    function closeModal() {
        modal.style.display = 'none';
    }

    async function loadShops() {
        const shopSelect = document.getElementById('productShop');
        const shopFilter = document.getElementById('shopFilter');
        
        try {
            const snapshot = await db.collection('shops').where('isActive', '==', true).get();
            allShops = [];
            shopSelect.innerHTML = '<option value="">Select Shop</option>';
            shopFilter.innerHTML = '<option value="">All Shops</option>';

            snapshot.forEach(doc => {
                const shop = { id: doc.id, ...doc.data() };
                allShops.push(shop);
                const option = document.createElement('option');
                option.value = shop.id;
                option.textContent = `${shop.name} (${shop.category})`;
                shopSelect.appendChild(option);
                shopFilter.appendChild(option.cloneNode(true));
            });
        } catch (error) {
            console.error("Error loading shops:", error);
        }
    }

    document.getElementById('productShop').addEventListener('change', function() {
        const shopId = this.value;
        const selectedShop = allShops.find(s => s.id === shopId);
        if (selectedShop) {
            document.getElementById('productCategory').value = selectedShop.category;
        }
    });

    async function loadProducts() {
        const container = document.getElementById('productsTableContainer');
        container.innerHTML = '<div class="loading">Loading products...</div>';
        try {
            const snapshot = await db.collection('products').orderBy('createdAt', 'desc').get();
            allProducts = [];
            snapshot.forEach(doc => {
                allProducts.push({ id: doc.id, ...doc.data() });
            });
            displayProducts(allProducts);
        } catch (error) {
            console.error("Error loading products:", error);
            container.innerHTML = `<p style="color:red">Error: ${error.message}</p>`;
        }
    }

    function displayProducts(products) {
        const container = document.getElementById('productsTableContainer');
        if (products.length === 0) {
            container.innerHTML = '<p>No products found. Add one!</p>';
            return;
        }

        let html = `
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Shop</th>
                        <th>Price</th>
                        <th>Unit</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
        `;
        products.forEach(product => {
            const shop = allShops.find(s => s.id === product.shopId);
            const shopName = shop ? shop.name : 'Unknown Shop';
            const statusClass = product.isAvailable ? 'badge-available' : 'badge-unavailable';
            const statusText = product.isAvailable ? 'Available' : 'Unavailable';
            html += `
                <tr id="row-${product.id}">
                    <td>${product.name}</td>
                    <td>${shopName}</td>
                    <td>â‚¹${product.price}</td>
                    <td>${product.unit}</td>
                    <td><span class="badge ${statusClass}">${statusText}</span></td>
                    <td>
                        <div class="action-btns">
                            <button class="btn-edit" onclick='openModal(${JSON.stringify(product)})'>Edit</button>
                            <button class="btn-delete" onclick="deleteProduct('${product.id}', '${product.name}')">Delete</button>
                        </div>
                    </td>
                </tr>
            `;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
    }

    productForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const btnSave = document.getElementById('btnSave');
        btnSave.disabled = true;
        btnSave.textContent = 'Saving...';

        const productId = document.getElementById('productId').value;
        const shopId = document.getElementById('productShop').value;
        const selectedShop = allShops.find(s => s.id === shopId);

        const productData = {
            name: document.getElementById('productName').value,
            shopId: shopId,
            shopName: selectedShop ? selectedShop.name : '',
            category: document.getElementById('productCategory').value,
            description: document.getElementById('productDescription').value,
            price: Number(document.getElementById('productPrice').value),
            unit: document.getElementById('productUnit').value,
            imageUrl: document.getElementById('productImageUrl').value,
            isAvailable: document.getElementById('productStatus').value === 'true',
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        try {
            if (productId) {
                await db.collection('products').doc(productId).update(productData);
                showToast('Product updated successfully!', 'success');
            } else {
                productData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                const docRef = await db.collection('products').add(productData);
                await db.collection('products').doc(docRef.id).update({ productId: docRef.id });
                showToast('Product added successfully!', 'success');
            }
            closeModal();
            loadProducts();
        } catch (error) {
            console.error('Error saving product:', error);
            showToast(`Error: ${error.message}`, 'error');
        } finally {
            btnSave.disabled = false;
            btnSave.textContent = 'Save Product';
        }
    });

    async function deleteProduct(productId, productName) {
        if (confirm(`Are you sure you want to delete "${productName}"?`)) {
            try {
                await db.collection('products').doc(productId).delete();
                showToast('Product deleted!', 'success');
                loadProducts();
            } catch (error) {
                console.error('Error deleting product:', error);
                showToast(`Error: ${error.message}`, 'error');
            }
        }
    }
    
    // --- Filtering ---
    document.getElementById('searchInput').addEventListener('keyup', applyFilters);
    document.getElementById('shopFilter').addEventListener('change', applyFilters);
    document.getElementById('statusFilter').addEventListener('change', applyFilters);

    function applyFilters() {
        const searchText = document.getElementById('searchInput').value.toLowerCase();
        const shopId = document.getElementById('shopFilter').value;
        const status = document.getElementById('statusFilter').value;

        let filteredProducts = allProducts.filter(product => {
            const searchMatch = product.name.toLowerCase().includes(searchText);
            const shopMatch = shopId ? product.shopId === shopId : true;
            const statusMatch = status ? product.isAvailable.toString() === status : true;
            return searchMatch && shopMatch && statusMatch;
        });
        displayProducts(filteredProducts);
    }

    // Initial Load
    checkAuth(async (user) => {
        document.getElementById('loadingScreen').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        await loadShops(); // Wait for shops to load first
        await loadProducts(); // Then load products
    });
</script>
</body>
</html>